<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天文4択クイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="tenmon_quiz.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    </head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="quiz-container" class="container w-full">

        <div class="flex justify-between items-center mb-6">
            
            <div class="flex items-center gap-4">
                <button id="home-button" class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg rounded-full shadow-md transition duration-150">
                    HOME
                </button>
                <h1 class="text-3xl font-bold text-gray-100">天文クイズ</h1> 
            </div>
            
            <div class="flex items-center gap-4">
                
                <div class="flex items-center gap-3">
                    <a href="https://www.instagram.com/cit.tenmon207/" target="_blank" rel="noopener noreferrer" class="sns-icon">
                        <i class="fa-brands fa-instagram fa-lg"></i>
                    </a>
                    <a href="https://x.com/Cittenmon" target="_blank" rel="noopener noreferrer" class="sns-icon">
                        <i class="fa-brands fa-x-twitter fa-lg"></i>
                    </a>
                </div>

                <div id="score-display" class="text-xl font-semibold text-sky-400 p-2 rounded-lg bg-gray-800 shadow-lg">
                    スコア: 0 / 0
                </div>
            </div>
		</div>
        <div id="game-area" class="question-card relative rounded-xl p-6 md:p-8">

                        <div class="text-center">                 <div class="mt-8">                     <button id="show-ranking-button" class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold text-lg rounded-full shadow-lg transition duration-150">
                        🏆 ランキングを見る
                    </button>
							</div>
                <div id="ranking-display-area" 
                     class="hidden mt-6 p-4 bg-gray-900 rounded-lg text-left text-white"
                     style="max-height: 400px; overflow-y: auto;">
                    
                    <div id="ranking-level-select">
                        <h3 class="text-xl font-bold text-yellow-400 text-center mb-4">🏆 ランキング 🏆</h3>
                        <p class="text-center mb-4">見るレベルを選択してください</p>
                        <div class="flex flex-col gap-3">
                            <button onclick="fetchAndDisplayRanking('1')" class="difficulty-button level-1 p-3">レベル 1</button>
                            <button onclick="fetchAndDisplayRanking('2')" class="difficulty-button level-2 p-3">レベル 2</button>
                            <button onclick="fetchAndDisplayRanking('3')" class="difficulty-button level-3 p-3">レベル 3</button>
                            <button onclick="fetchAndDisplayRanking('4')" class="difficulty-button level-4 p-3">レベル 4</button>
                            <button onclick="fetchAndDisplayRanking('5')" class="difficulty-button level-5 p-3">レベル 5</button>
                        </div>
                        <button onclick="closeRankingDisplay()" class="mt-4 w-full p-2 bg-gray-600 hover:bg-gray-700 rounded">閉じる</button>
                    </div>
                    
                    <div id="ranking-result-display" class="hidden">
                                            </div>

                </div>
            </div>
                        <div id="difficulty-select-screen" class="text-center">
                <h1 class="text-3xl font-bold text-gray-100 mb-2">天文クイズ</h1>
                <p class="text-xl text-sky-400 mb-8">難易度を選択してください</p>

                <div class="flex flex-col gap-4">
                    <button onclick="selectDifficulty('1')" class="difficulty-button level-1 block w-full p-4 bg-gray-800 text-gray-100 font-semibold text-lg rounded-lg text-center shadow-md transition duration-200">
                        レベル 1
                    </button>
                    <button onclick="selectDifficulty('2')" class="difficulty-button level-2 block w-full p-4 bg-gray-800 text-gray-100 font-semibold text-lg rounded-lg text-center shadow-md transition duration-200">
                        レベル 2
                    </button>
                    <button onclick="selectDifficulty('3')" class="difficulty-button level-3 block w-full p-4 bg-gray-800 text-gray-100 font-semibold text-lg rounded-lg text-center shadow-md transition duration-200">
                        レベル 3
                  _E38080 </button>
                    <button onclick="selectDifficulty('4')" class="difficulty-button level-4 block w-full p-4 bg-gray-800 text-gray-100 font-semibold text-lg rounded-lg text-center shadow-md transition duration-200">
                        レベル 4
                    </button>
              _E38080_E38080 <button onclick="selectDifficulty('5')" class="difficulty-button level-5 block w-full p-4 bg-gray-800 text-gray-100 font-semibold text-lg rounded-lg text-center shadow-md transition duration-200">
nbsp;                     レベル 5
                    </button>
                </div>
				
                                                                <div class="absolute bottom-3 right-4">
                    <a href="secret.html" 
                        class="text-xs text-[#171c23] hover:text-sky-400 no-underline transition-colors"
s                     title="?????????????">
                        *
                    </a>
route_tokens:             </div>
            </div>

            <div id="start-screen" class="text-center hidden">
                <h2 class="text-2xl font-bold mb-4 text-white">宇宙の知識を試そう！</h2>
                <p class="text-gray-400 mb-6">スタートボタンを押してクイズを開始してください。</p>
E            <button id="start-button" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold text-lg rounded-full shadow-xl transition duration-150 transform hover:scale-105">
                    クイズスタート
                </button>
            </div>
            
            <div id="quiz-screen" class="hidden">
Image           <div class="mb-6">
                    <p id="question-number" class="text-sm font-medium text-sky-400 mb-2">問題 1 / 10</p>
                    <div id="question-area" class="text-xl md:text-2xl font-semibold text-gray-100 p-4 bg-gray-700 rounded-lg">
                        問題文がここに表示されます
                    </div>
                </div>
A             <div id="choices-area" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
                <div id="feedback-area" class="mt-6 h-8 text-center text-xl font-bold">
.               </div>
            </div>

            <div id="exp-screen" class="hidden">
                <div class="mb-6">
                    <p class="text-lg font-semibold text-gray-100 mb-2">正解</p>
                    <div id="answer-area" class="text-2xl md:text-3xl font-bold text-green-500 p-4 bg-gray-800 rounded-lg mb-4 text-center">
                    </div>
                    <p class="text-sm font-medium text-sky-400 mb-2">解説</p>
S               <div id="exp-area" class="text-xl md:text-2xl font-semibold text-gray-100 p-4 bg-gray-700 rounded-lg" style="min-height: 100px;">
                    </div>
                </div>
                <div class="text-center">
                    <button id="next-button" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg rounded-full shadow-xl transition duration-150 transform hover:scale-105">
                        次へ進む
                    </button>
                </div>
            </div>
            
            <div id="result-screen" class="hidden text-center">
S             <h2 id="result-title" class="text-3xl font-bold mb-4 text-yellow-300"></h2>
                <p id="final-score-text" class="text-5xl font-extrabold text-green-500 mb-6"></p>
ci             <p class="text-gray-400 mb-6">また挑戦して、宇宙博士を目指そう！</p>
                <a href="index.html" id="restart-button" class="inline-block no-underline px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg rounded-full shadow-xl transition duration-150 transform hover:scale-105">
Sure                 もう一度プレイ
                </a>
            </div>
        </div>    
	</div>

    <script>
        // ▼▼▼ JavaScriptの処理開始 ▼▼▼
		
		const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyzvBFBRYLyrZzfdsGcWoaU7hXIUggbPUqGcX9zK4qL6Cg9F6kbtKKvplekCwMtOpH4/exec";
        
        // --- 1. 全レベルのクイズデータを定義 ---
        // const: 定数（中身が変わらないデータ）を宣言します。
        // allQuizData: すべてのクイズデータをまとめた「オブジェクト」です。
        // "1": [ ... ], "2": [ ... ] のように、難易度レベルごとにクイズの配列（リスト）を持っています。
        // { question: "...", choices: ["...", ...], answer: "...", exp: "..." } が1問分のデータです。
        const allQuizData = {
            "1": [
                { question: "月は地球の周りを回りながら自転しています。月は約何日で1回自転をするでしょう？", choices: ["約1日", "約27日", "約60日", "約243日"], answer: "約27日", exp:"" },
                { question: "日本の一年のうち、一番昼が短い日は、次のうちどれでしょう？", choices: ["春分の日", "夏至", "秋分の日", "冬至"], answer: "冬至", exp:"" },
                { question: "国際天文学連合によると、現在星座は何個あるとされているでしょう？", choices: ["44個", "66個", "88個", "102個"], answer: "88個", exp:"" },
                { question: "自ら光を発している星をなんというでしょう？", choices: ["恒星", "惑星", "光星", "彗星"], answer: "恒星", exp:"" },
                { question: "太陽系の惑星の中で最も大きいものはどれでしょう？", choices: ["地球", "火星", "木星", "土星"], answer: "木星", exp:"" },
                { question: "現在の北極星は次のうちどれでしょう？", choices: ["ベガ", "ポラリス", "エライ", "デネブ"], answer: "ポラリス", exp:"" },
                { question: "次のうち黄道12星座に含まれていないものはどれでしょう？", choices: ["おうし座", "おおぐま座", "おひつじ座", "やぎ座"], answer: "おおぐま座", exp:"" },
                { question: "惑星の周りをまわる星をなんと呼ぶでしょう？", choices: ["恒星", "小惑星", "衛星", "周惑星"], answer: "衛星", exp:"" },
                { question: "主成分が氷と塵であり、別名ほうき星と呼ばれる星は何でしょう？", choices: ["衛星", "氷星", "塵星", "彗星"], answer: "彗星", exp:"" },
                { question: "冬の大三角を構成する星はオリオン座のベテルギウス、おおいぬ座のシリウスとこいぬ座のなんでしょう？", choices: ["ベガ", "アルタイル", "プロキオン", "アルデバラン"], answer: "プロキオン", exp:"" }
            ],
            "2": [
                { question: "太陽と地球の距離は何kmでしょう？", choices: ["約100万km", "約5000万km", "約1億5000万km", "約5億km"], answer: "約1億5000万km", exp:"" },
                { question: "火星を表す惑星記号はどれでしょう？", choices: ["♀", "♂", "♄", "♃"], answer: "♂", exp:"" },
                { question: "太陽の表面温度は約何度でしょう？", choices: ["約6000℃", "約10000℃", "約12000℃", "約16000℃"], answer: "約6000℃", exp:"" },
                { question: "最近、ミクロの研究が盛んなことでよく聞く「μ」や「n」ですが、10の-9乗を表すのはどれでしょう？", choices: ["μ（マイクロ）", "n（ナノ）", "Å（オングストローム）", "m（ミリ）"], answer: "n（ナノ）", exp:"" },
                { question: "有名な源平合戦ですが、ある天文的な現象が勝敗を分けた戦いがあると言われています。その現象とは何でしょう？", choices: ["月食", "日食", "新月", "太陽フレア"], answer: "日食", exp:"" },
                { question: "太陽系の惑星の中で衛星を持たないものはどれでしょう？", choices: ["木星", "金星", "地球", "火星"], answer: "金星", exp:"" },
                { question: "現在、世界の多くの国々で採用されている太陽暦は何でしょう？", choices: ["ハアブ暦", "グレゴリオ暦", "ユリウス暦", "ツォルキン暦"], answer: "グレゴリオ暦", exp:"" },
                { question: "主成分はガスと塵であり、自ら光らず背後の星の光を遮ることで観測される星間雲を何というでしょう？", choices: ["暗黒星雲", "反射星雲", "散光星雲", "惑星上星雲"], answer: "暗黒星雲", exp:"" },
                { question: "北極星を見つける際に用いられる北斗七星とカシオペヤ座ですが、いずれも基準となる線を何倍すると北極星に辿り着けるでしょう？", choices: ["2倍", "3倍", "5倍", "8倍"], answer: "5倍", exp:"" },
                { question: "天球上における太陽の通り道をなんと呼ぶでしょう？", choices: ["赤道", "金道", "白道", "黄道"], answer: "黄道", exp:"" }
            ],
            "3": [
                { question: "地球で体重30kgの人が月面で体重計に乗ると何kgになるでしょう？", choices: ["5kg", "10kg", "30kg", "180kg"], answer: "5kg", exp:"" },
                { question: "地球は月の何倍の大きさ（直径）を持つでしょう？", choices: ["2倍", "4倍", "6倍", "8倍"], answer: "4倍", exp:"" },
                { question: "最近話題となったレモン彗星は、何から名付けられたでしょう？", choices: ["発見者", "観測地", "色", "形"], answer: "観測地", exp:"" },
                { question: "88星座の中で、1つの星座が2つの領域に分けられているものはどれでしょう？", choices: ["うお座", "てんびん座", "へび座", "しし座"], answer: "へび座", exp:"" },
                { question: "三大流星群とはしぶんぎ座流星群、ペルセウス流星群となんでしょう？", choices: ["オリオン流星群", "おうし座流星群", "しし座流星群", "ふたご座流星群"], answer: "ふたご座流星群", exp:"" },
                { question: "太陽の表面には「黒点」というものがありますが、その特徴として、当てはまらないものはどれでしょう？", choices: ["表面温度が周りより低い", "磁場が周りより強い", "場所が変わる", "直径約500km"], answer: "直径約500km", exp:"" },
                { question: "一等星は2等星の何倍の明るさをもつでしょう？", choices: ["約2倍", "約2.5倍", "約5倍", "約10倍"], answer: "約2.5倍", exp:"" },
                { question: "太陽風とは何でしょう？", choices: ["風", "プラズマ", "光", "圧力"], answer: "プラズマ", exp:"" },
                { question: "次のうち、星座に描かれていない動物はなんでしょう？", choices: ["うし", "とら", "うさぎ", "へび"], answer: "とら", exp:"" },
                { question: "天の北極があるのはこぐま座ですが、天の南極があるのは何座でしょう？", choices: ["しぶんぎ座", "ろくぶんぎ座", "はちぶんぎ座", "じゅうぶんぎ座"], answer: "はちぶんぎ座", exp:"" }
            ],
            "4": [
				{
					question: "古代ギリシャ語で木星のことをなんと呼ぶでしょう？",
					choices: ["ゼウス", "ジュピター", "ビーナス", "アレス"],
                answer: "ゼウス",
                exp:"ジュピターはローマ神話における木星、ビーナスはローマ神話における金星、アレスはギリシャ神話における火星に相当する。"
            },
            {
                question: "新潟を本拠地とするサッカーチーム・野球チームの名称の由来にもなっている、橙色と青色のコントラストが美しいはくちょう座の二重星はなんでしょう？",
                choices: ["デネブ", "アルビレオ", "アルコル", "デネボラ"],
                answer: "アルビレオ",
                exp:"黄色に輝く星がアルビレオA、青色に輝く星がアルビレオBと呼ばれる"
            },
            {
                question: "国旗に描かれている星にはそれぞれ一つの州が当てられている国はどこでしょう？",
                choices: ["メキシコ", "中国", "ベトナム", "ブラジル"],
                answer: "ブラジル",
                exp:"ブラジル国旗の星は、27個の星で、それぞれの星がブラジル連邦を構成する26州と1つの連邦直轄区を表している"
            },
            {
                question: "かつて最も大きな星座であったアルゴ船座は4つに分割されましたが、その4つの星座に含まれないのは次のうちどれでしょう？",
                choices: ["らしんばん座", "ポンプ座", "ほ座", "りゅうこつ座"],
                answer: "ポンプ座",
                exp:"古くから存在する星座であったが、大きすぎたため国際天文学連合がりゅうこつ座、とも座、ほ座、てんびん座の4つに分割した"
            },
            {
                question: "次のうち、距離が最も長いものはどれか。",
                choices: ["10億km", "1パーセク", "1光年", "1天文単位"],
                answer: "1パーセク",
                exp:"１天文単位がおよそ１億5000万kmであり、１光年は63000天文単位、１パーセクは3.26光年である"
            },
            {
                question: "ラテン語で穀物の穂の意味を持つ星は、次のうちどれでしょう？",
                choices: ["シリウス", "プロキオン", "スピカ", "リゲル"],
                answer: "スピカ",
                exp:"シリウスはギリシャ語で「焼き焦がすもの」、プロキオンはギリシャ語で「犬の前に」、リゲルはアラビア語で「巨人の足」という意味である。"
            },
            {
                question: "天文単位(au)について、間違った説明文はどれでしょう？",
                choices: ["太陽-冥王星間は約5auと表される", "地球-太陽間の平均距離に由来する単位である", "1auを約1億5000kmとする距離の単位である", "auとは、astronomical unitの略称である"],
                answer: "太陽-冥王星間は約5auと表される",
                exp:"太陽-冥王星間は約40auである。5auは太陽と木星の距離に相当する"
            },
            {
                question: "宇宙線の主成分は何か。",
                choices: ["高エネルギーの電子", "高エネルギーの陽子", "高エネルギーのアルファ粒子", "高エネルギーのガンマ線"],
                answer: "高エネルギーの陽子",
                exp:"陽子が宇宙線の約九割を占めている。"
            },
            {
                question: "地球の重力を振り切って進むことが出来るようになる「第二宇宙速度」の値はどれでしょう？",
                choices: ["約7.9km/s", "約9.8km/s", "約11.2km/s", "約16.7km/s"],
                answer: "約11.2km/s",
                exp:"宇宙速度とも呼ばれる"
            },
            {
                question: "次に日本で皆既日食が見られると予想されている日は次のうちどれでしょう？",
                choices: ["2031年5月21日", "2032年11月3日", "2035年9月2日", "2117年12月11日"],
                answer: "2035年9月2日",
                exp:"北陸地方から北関東にかけて観測可能とされている"
            }
            ],
            "5": [
                { question: "太陽系の惑星の中で公転周期の離心率が最も大きいのはどれでしょう？",
                choices: ["水星", "金星", "海王星", "火星"],
                answer: "水星",
                exp:"離心率とは曲線の特徴を表す数値であり、0ならば完全な円　0以上１以下ならば楕円を表す。それぞれの離心率は水星が0.205,金星は0.0068、海王星が0.009、火星は0.093である。"
            },
            {
                question: "歳差運動によって北極星は移り変わっていきます。次のうち、北極星の役割とならない星はどれでしょう？",
                choices: ["ベガ", "デネブ", "ポラリス", "アルデバラン"],
                answer: "アルデバラン",
                exp:"ポラリスが現在の北極星であり、約8300年後にデネブ、約12000年後にベガが北極星になる。"
            },
            {
                question: "ニコラウス・コペルニクスについての間違った説明文はどれでしょう？",
                choices: ["ポーランド出身である", "「天球の回転について」の著者であり、地動説を唱えた", "天動説を否定したため、カトリック教会の宗教裁判にかけられた", "ヨーロッパルネサンス時代の天文学者である"],
                answer: "天動説を否定したため、カトリック教会の宗教裁判にかけられた",
                exp:"コペルニクスは地動説を唱えたが、宗教裁判にはかけられていない。"
            },
            {
                question: "世界で初めて月に軟着陸をした月探査機はどれでしょう？",
                choices: ["ルナ2号", "ルナ9号", "アポロ8号", "アポロ9号"],
                answer: "ルナ9号",
                exp:"ルナ２号は月面に衝突、アポロ8号は月面の裏を確認、アポロ9号は史上初のドッキングを行った。"
            },
            {
                question: "世界で初めて有人での月面着陸に成功した月探査機はどれでしょう？",
                choices: ["ルナ9号", "かぐや", "アポロ8号", "アポロ11号"],
                answer: "アポロ11号",
                exp:"ルナ9号は無人での月面着陸である。かぐやは2007年に打ち上げられた比較的新しい探査機である。アポロ8号は月面を周回した。"
            },
            {
                question: "各国の月探査機の名前で、月が由来になっていないものはどれでしょう？？",
                choices: ["中国の嫦娥", "ロシアのルナ", "インドのチャンドラヤーン", "アメリカのアポロ"],
                answer: "アメリカのアポロ",
                exp:"嫦娥(じょうが)は中国神話の月神に由来する。ルナはローマ神話の月の神である。チャンドラヤーンはサンスクリット語で月の乗り物という意味である。"
            },
            {
                question: "次のうち、最も公転周期の短い彗星はどれでしょう？？",
                choices: ["ヘール・ボップ彗星", "エンケ彗星", "レモン彗星", "スワン彗星"],
                answer: "エンケ彗星",
                exp:"それぞれの公転周期は、ヘール・ボップ彗星が4200年、エンケ彗星は3.3年、レモン彗星が1350年、スワン彗星は20,000年以上と推定されている。"
            },
            {
                question: "現在、星空保護区に認定されていない場所はどこでしょう？",
                choices: ["神津島(東京)", "南六呂師(福井)", "西表石垣国立公園(沖縄)", "阿智村(長野)"],
                answer: "阿智村(長野)",
                exp:"2025年時点で、西表石垣国立公園　神津島　井原市美星町　大野市南六呂師エリアの4つが星空保護区に指定されている。"
            },
            {
                question: "恒星の最後の姿として有名な「超新星爆発残骸」ですが、「超新星爆発」を起こすか起こさないかの境目になるのは太陽質量(太陽の質量を1としたとき)の何倍でしょう？",
                choices: ["4倍", "8倍", "16倍", "32倍"],
                answer: "8倍",
                exp:"重力崩壊型超新星爆発を起こすのに必要な質量は6-10倍だとされている。"
            },
            {
                question: "最初に国産の反射望遠鏡を作ったのは誰でしょう？",
                choices: ["岩橋善兵衛", "森仁左衛門", "伊能忠敬", "国友藤兵衛"],
                answer: "国友藤兵衛",
                exp:"国友藤兵衛は他にも実用空気銃を作成しており江戸時代のエジソンとも呼ばれる"
            }
            ]
        };

        // --- 2. グローバル変数 ---
        // let: 変数（中身が変わるデータ）を宣言します。
        // これらはプログラム全体で使う「状態」を保存・管理するための変数です。
        let currentQuestionIndex = 0; // 現在、第何問目か (0からスタート)
        let score = 0;                // 現在の正解数
        let quizActive = false;       // クイズが回答可能状態か (true=はい, false=いいえ)
        let shuffledQuizData = [];    // 出題順をシャッフルしたクイズデータを入れる配列
        let selectedQuizData = [];    // 選択された難易度のクイズデータを入れる配列
        let currentLevel = '1';       // 現在選択されている難易度レベル
		let startTime = 0;            // タイム計測開始時間 

        // --- 3. DOM要素の取得 ---
        // HTMLの要素（部品）を、JavaScriptで操作できるように変数に入れています。
        // document.getElementById('ID名'): HTML側で指定した 'id' を持つ要素を探して取得します。
        const homeButton = document.getElementById('home-button'); // HOMEボタン
        const difficultySelectScreen = document.getElementById('difficulty-select-screen'); // 難易度選択画面
        const startScreen = document.getElementById('start-screen');     // スタート画面
        const quizScreen = document.getElementById('quiz-screen');       // クイズ画面
        const expScreen = document.getElementById('exp-screen');         // 解説画面
        const resultScreen = document.getElementById('result-screen');   // 結果画面
        const startButton = document.getElementById('start-button');     // スタートボタン
        const nextButton = document.getElementById('next-button');       // 次へ進むボタン
        const scoreDisplay = document.getElementById('score-display');   // スコア表示エリア
        const questionNumber = document.getElementById('question-number'); // 問題番号エリア
        const questionArea = document.getElementById('question-area');     // 問題文エリア
        const choicesArea = document.getElementById('choices-area');       // 選択肢エリア
        const feedbackArea = document.getElementById('feedback-area');     // 正解/不正解フィードバックエリア
        const answerArea = document.getElementById('answer-area');       // (解説画面の)正解表示エリア
        const expArea = document.getElementById('exp-area');         // (解説画面の)解説文エリア
        const resultTitle = document.getElementById('result-title');     // (結果画面の)タイトルエリア
        const finalScoreText = document.getElementById('final-score-text'); // (結果画面の)最終スコアエリア
        // document.querySelector('セレクタ'): CSSと同じ方法で要素を探します (これは h1 タグを探しています)
        const mainTitle = document.querySelector('#quiz-container h1'); // ページ上部の「天文クイズ」タイトル
        const startScreenTitle = document.getElementById('start-screen').querySelector('h2'); // スタート画面の「宇宙の知識を試そう！」タイトル
		const showRankingButton = document.getElementById('show-ranking-button'); 
		const rankingDisplayArea = document.getElementById('ranking-display-area');


        // --- 4. 関数定義 ---
        // function 関数名(引数) { ... }: 「関数」を定義します。
        // 関数は、特定の処理をひとまとめにしたもので、名前を呼ぶことで何度でも実行できます。

        /**
         * @function selectDifficulty
         * @description 難易度を選択し、テーマとクイズデータを設定する
         * @param {string} level - 選択された難易度レベル (例: '1')
         */
        function selectDifficulty(level) {
            // 1. レベルとクイズデータをセット
            currentLevel = level; // 選ばれたレベルを保存
            selectedQuizData = allQuizData[currentLevel]; // 全クイズデータから、選ばれたレベルのデータを取り出す

            // 2. タイトルと問題数を更新
            mainTitle.textContent = `天文クイズレベル${currentLevel}`; // 上部のタイトルを変更
            const totalQuestions = selectedQuizData.length; // 問題数を取得
            startScreenTitle.textContent = `全${totalQuestions}問！宇宙の知識を試そう！`; // スタート画面のタイトルを変更
            scoreDisplay.textContent = `スコア: 0 / ${totalQuestions}`; // スコア表示を初期化

            // 3. 画面を切り替え
            // classList.add('hidden'): 'hidden' クラスを追加して非表示にする
            // classList.remove('hidden'): 'hidden' クラスを削除して表示する
            difficultySelectScreen.classList.add('hidden'); // 難易度選択画面を隠す
            startScreen.classList.remove('hidden');       // スタート画面を表示する
            homeButton.classList.remove('hidden');        // HOMEボタンを表示する
        }

        /**
         * @function handleHomeClick
         * @description HOMEボタンが押された時の処理。クイズ中か判定して確認ダイアログを出す
         */
        function handleHomeClick() {
            // クイズ画面または解説画面が表示されているか（= hiddenクラスが付いていないか）
            const isQuizInProgress = !quizScreen.classList.contains('hidden') || !expScreen.classList.contains('hidden');

            // もしクイズ進行中なら
            if (isQuizInProgress) {
                // confirm() で「OK」「キャンセル」のダイアログ（警告）を表示
                if (confirm("クイズの進行度は失われます。それでもホームに戻りますか？")) {
                    // 「OK」(true) が押されたらHOMEに戻る
                    returnToHome();
                } else {
                    // 「キャンセル」(false) が押されたら何もしない
                }
            } else {
                // クイズ中でなければ（スタート画面や結果画面）、確認なしでHOMEに戻る
                returnToHome();
            }
        }

        /**
         * @function returnToHome
         * @description 状態をすべてリセットし、難易度選択画面（HOME）に戻る
         */
        function returnToHome() {
            // 1. すべての画面を非表示にする
            startScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            expScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');

            // 2. 難易度選択画面を表示する
            difficultySelectScreen.classList.remove('hidden');

            // 3. HOMEボタン自体を非表示にする
            homeButton.classList.add('hidden');

            // 4. タイトルやスコア表示を初期状態に戻す
            mainTitle.textContent = "天文クイズ";
            scoreDisplay.textContent = "スコア: 0 / 0";
            startScreenTitle.textContent = "宇宙の知識を試そう！"; // スタート画面のタイトルもリセット

            // 6. クイズの状態管理変数をリセット
			closeRankingDisplay();
            currentQuestionIndex = 0;
            score = 0;
            quizActive = false;
            shuffledQuizData = [];
            selectedQuizData = [];
            currentLevel = '1'; // （念のため初期レベルに戻す）
        }


        /**
         * @function shuffleArray
         * @description 配列の要素をランダムにシャッフルする（フィッシャー・イェーツのシャッフル）
         * @param {array} array - シャッフルしたい配列
         * @returns {array} - シャッフルされた新しい配列
         */
        function shuffleArray(array) {
            let newArray = array.slice(); // 元の配列をコピーして新しい配列を作る
            // 配列の後ろから順番に、ランダムに選んだ要素と入れ替えていく
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; 
            }
            return newArray; // シャッフル後の配列を返す
        }

        /**
         * @function startGame
         * @description クイズゲームを開始する
         */
        function startGame() {
            // 選ばれた難易度のクイズデータをシャッフルして、出題用データ(shuffledQuizData)に保存
            shuffledQuizData = shuffleArray(selectedQuizData);
            currentQuestionIndex = 0; // 問題番号をリセット (0問目から)
            score = 0;                // スコアをリセット
            quizActive = true;        // 回答可能な状態にする
			startTime = Date.now();   // タイム計測開始
            // 画面切り替え
            startScreen.classList.add('hidden');  // スタート画面を隠す
            resultScreen.classList.add('hidden'); // 結果画面を隠す
            expScreen.classList.add('hidden');    // 解説画面を隠す
            quizScreen.classList.remove('hidden'); // クイズ画面を表示する
            
            updateScoreDisplay(); // スコア表示を更新 (0 / 10 のように)
            displayQuestion();    // 最初の問題を表示
        }

        /**
         * @function updateScoreDisplay
         * @description 現在のスコアを画面上部のスコア表示エリアに反映する
         */
        function updateScoreDisplay() {
            scoreDisplay.textContent = `スコア: ${score} / ${shuffledQuizData.length}`;
        }

        /**
         * @function displayQuestion
         * @description 次の問題を表示する。もし全問終了していれば結果画面へ
         */
        function displayQuestion() {
            // 解説画面が表示されていれば隠し、クイズ画面を表示する
            expScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');

            // もし現在の問題番号(index)が問題数以上なら、全問終了
            if (currentQuestionIndex >= shuffledQuizData.length) {
                endGame(); // 結果発表関数を呼ぶ
                return;    // この関数の処理をここで終了
            }

            // 出題する現在のクイズデータを取得
            const currentQuiz = shuffledQuizData[currentQuestionIndex];
            
            // 問題番号と問題文を画面に表示
            // (indexは0から始まるので、+1 して「問題 1」のように表示)
            questionNumber.textContent = `問題 ${currentQuestionIndex + 1} / ${shuffledQuizData.length}`;
            questionArea.textContent = currentQuiz.question;
            
            // 選択肢エリア(choicesArea)の中身を一旦空にする
            choicesArea.innerHTML = ''; 

            // クイズデータの choices (選択肢の配列) を1つずつ取り出してボタンを作成
            currentQuiz.choices.forEach(choice => {
                // <button> 要素をプログラムで作成
                const button = document.createElement('button');
                button.textContent = choice; // ボタンのテキストを選択肢の文字列に設定
                
                // ボタンのデザイン（クラス）を設定
                button.classList.add(
                    'choice-button', 'p-4', 'bg-gray-800', 'text-gray-100', 'font-semibold',
                    'rounded-lg', 'text-left', 'shadow-md', 'transition', 'duration-200'
                );
                
                // ボタンがクリックされた時の動作を設定
                // 'click' したら、checkAnswer関数を呼ぶ
                button.addEventListener('click', () => checkAnswer(choice, button));
                
                // 作成したボタンをHTMLの choicesArea に追加
                choicesArea.appendChild(button);
            });
            
            quizActive = true; // 回答可能な状態にする
            feedbackArea.textContent = ''; // 正解/不正解の表示を空にする
        }

        /**
         * @function checkAnswer
         * @description 選択された答えが合っているか判定する
         * @param {string} selectedChoice - ユーザーが選んだ選択肢の文字列
         * @param {HTMLElement} selectedButton - ユーザーが押したボタン要素
         */
        function checkAnswer(selectedChoice, selectedButton) {
            // もし quizActive が false (回答不可状態) なら、何もせず処理を終了
            // (連打防止のため)
            if (!quizActive) return;
            quizActive = false; // 回答不可状態にする

            // 現在の問題のデータを取得
            const currentQuiz = shuffledQuizData[currentQuestionIndex];
            // 選んだ答え(selectedChoice)と正解(currentQuiz.answer)が同じか判定
            const isCorrect = selectedChoice === currentQuiz.answer;

            // 選択肢ボタンすべてに対して処理
            Array.from(choicesArea.children).forEach(button => {
                button.disabled = true; // ボタンを押せないようにする
                
                // もしボタンのテキストが正解の答えなら
                if (button.textContent === currentQuiz.answer) {
                    button.classList.add('bg-green-600', 'ring-4', 'ring-green-400'); // 緑色にする
                    button.classList.remove('bg-gray-800'); // 元の灰色を消す
                // もし、押したボタン(selectedButton)で、かつ、不正解(isCorrectがfalse)なら
                } else if (button === selectedButton && !isCorrect) {
                    button.classList.add('bg-red-600', 'ring-4', 'ring-red-400'); // 赤色にする
                    button.classList.remove('bg-gray-800'); // 元の灰色を消す
                }
            });

            // 正解だった場合
            if (isCorrect) {
                score++; // スコアを1増やす
                feedbackArea.textContent = '✅ 正解！！';
                feedbackArea.classList.remove('text-red-500'); // 赤文字クラスを削除
                feedbackArea.classList.add('text-green-500'); // 緑文字クラスを追加
            // 不正解だった場合
            } else {
                feedbackArea.textContent = '❌ 不正解...';
                feedbackArea.classList.remove('text-green-500'); // 緑文字クラスを削除
                feedbackArea.classList.add('text-red-500');   // 赤文字クラスを追加
            }
            
            updateScoreDisplay(); // スコア表示を更新
            
            // 2秒後（2000ミリ秒後）に showExplanation 関数を実行する
            setTimeout(showExplanation, 2000);
        }

        /**
         * @function showExplanation
         * @description 解説画面を表示する
         */
        function showExplanation(){
            // 現在の問題データを取得
            const currentQuiz = shuffledQuizData[currentQuestionIndex];
            
            // 正解と解説文を画面にセット
            answerArea.textContent = currentQuiz.answer;
            // もし解説文(exp)が空なら、デフォルトのメッセージを表示
            expArea.textContent = currentQuiz.exp || '解説は準備中です。'; 
            
            // 画面切り替え
            quizScreen.classList.add('hidden'); // クイズ画面を隠す
            expScreen.classList.remove('hidden'); // 解説画面を表示する
        }

        /**
         * @function nextQuestion
         * @description 次の問題へ進む（「次へ進む」ボタンが押された時に呼ばれる）
         */
        function nextQuestion() {
            expScreen.classList.add('hidden'); // 解説画面を隠す
            currentQuestionIndex++; // 問題番号を1増やす
            displayQuestion(); // 次の問題を表示する関数を呼ぶ
        }

        /**
         * @function endGame
         * @description クイズがすべて終了した時に呼ばれ、結果画面とスコア送信処理を行う
         */
        function endGame() {
            // 画面切り替え
            quizScreen.classList.add('hidden');
            expScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            
			// タイム計測終了
            const endTime = Date.now();
			const clearTime = (endTime - startTime) / 1000;
            // (endTime - startTime) はミリ秒なので、1000で割って秒単位にする
			const formattedTime = formatTime(clearTime);
            const total = shuffledQuizData.length;
            
            // スコアに応じて結果メッセージを変更
            let titleText = "";
            if (score === total) {
                titleText = "満点！Perafect！";
            } else if (score >= total * 0.7) {
                titleText = "7割越え！すごい！！";
            } else {
                titleText = "再度挑戦！!";
            }
            
            // 結果画面にメッセージと最終スコアを表示
            resultTitle.textContent = titleText; 
            finalScoreText.textContent = `${score} / ${total} (${formattedTime})`; 
            scoreDisplay.textContent = `最終スコア: ${score} / ${total}`;

            // --- ▼▼▼ ランキング送信処理 ▼▼▼ ---
            setTimeout(() => {
                const userName = prompt("ランキングに登録する名前を入力してください（キャンセル可）", "名無しの宇宙博士");
                
                if (userName) {
                    // ★postData に level と time を追加 (修正)
                    const postData = {
                        name: userName,
                        score: score,
                        level: currentLevel, // 現在のレベル
                        time: clearTime      // クリアタイム
                    };

                    alert("スコアを送信しています...");

                    // fetch API (送信処理自体は変更なし)
                    fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(postData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // ★アラートメッセージを修正
                            alert(`${userName}さん (レベル${data.level}) のスコア「${data.score}点 / ${formattedTime}」を登録しました！`);
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('スコア送信エラー:', error);
                        alert('スコアの登録に失敗しました。\n' + error.message);
                    });
                }
            }, 500); // 0.5秒後に実行
            // --- ▲▲▲ ランキング送信処理ここまで ▲▲▲ ---
        }
		function formatTime(totalFloatSeconds) {
            // 少数点以下を切り捨てて整数秒にする
            const totalIntSeconds = Math.floor(totalFloatSeconds);
            
            // 分を計算
            const minutes = Math.floor(totalIntSeconds / 60);
            // 残りの秒を計算
            const seconds = totalIntSeconds % 60;

            if (minutes > 0) {
                // 1分以上の場合
                return `${minutes}分${seconds}秒`;
            } else {
                // 1分未満の場合
                return `${seconds}秒`;
            }
        }
		
        /**
         * @function displayRanking
         * @description ランキング表示の開閉機能（表示/非表示）
         * （メインの「ランキングを見る/閉じる」ボタンから呼ばれる）
         */
        function displayRanking() {
            const isRankingVisible = !rankingDisplayArea.classList.contains('hidden');
            
            if (isRankingVisible) {
                // --- 既に表示されている場合 → 閉じる
                closeRankingDisplay();
            } else {
                // --- 非表示の場合 → 開く
                document.getElementById('ranking-result-display').classList.add('hidden');
                document.getElementById('ranking-level-select').classList.remove('hidden');
                rankingDisplayArea.classList.remove('hidden');
                
                // ボタンのテキストを「閉じる」に変更
                showRankingButton.innerHTML = '🏆 ランキングを閉じる';
            }
        }

        /**
         * @function fetchAndDisplayRanking
         * (変更なし)
         */
        function fetchAndDisplayRanking(level) {
            // (処理内容は変更なし)
            const levelSelectArea = document.getElementById('ranking-level-select');
            const resultDisplayArea = document.getElementById('ranking-result-display');
            resultDisplayArea.innerHTML = `<p class="text-center">レベル ${level} のランキングを読み込み中...</p>`;
            levelSelectArea.classList.add('hidden');
            resultDisplayArea.classList.remove('hidden');

            fetch(GAS_WEB_APP_URL + "?level=" + level) 
                .then(response => response.json())
                .then(data => {
                    // (処理内容は変更なし)
                    if (data.status === 'error') {
                        throw new Error(data.message);
                    }
                    let html = `<h3 class="text-xl font-bold text-yellow-400 text-center mb-3">🏆 レベル ${level} TOP 10 🏆</h3>`;
                    if (data.length === 0) {
                        html += '<p class="text-center">まだランキングデータがありません。</p>';
                    } else {
                        html += '<ol class="list-decimal list-inside space-y-2">';
                        data.forEach((item, index) => {
                            let medal = '';
                            if(index === 0) medal = '🥇';
                            if(index === 1) medal = '🥈';
                            if(index === 2) medal = '🥉';
                            const formattedTime = formatTime(item.time);
                            html += `<li>${medal} <strong>${item.name}</strong>: ${item.score}点 (${formattedTime})</li>`;
                        });
                        html += '</ol>';
                    }
                    // 「レベル選択に戻る」ボタンが showLevelSelect() を呼ぶ
                    html += '<button onclick="showLevelSelect()" class="mt-4 w-full p-2 bg-gray-600 hover:bg-gray-700 rounded">レベル選択に戻る</button>';
                    resultDisplayArea.innerHTML = html;
                })
                .catch(error => {
                    console.error('ランキング取得エラー:', error);
                    resultDisplayArea.innerHTML = `<p class="text-center text-red-500">ランキングの取得に失敗しました。</p><button onclick="showLevelSelect()" class="mt-4 w-full p-2 bg-gray-600 hover:bg-gray-700 rounded">レベル選択に戻る</button>`;
                });
        }

        /**
         * @function fetchAndDisplayRanking
         * @description 指定されたレベルのランキングをGASから取得して表示する
         * @param {string} level - 取得したいレベル ('1', '2', ...)
         */
        function fetchAndDisplayRanking(level) {
            const levelSelectArea = document.getElementById('ranking-level-select');
            const resultDisplayArea = document.getElementById('ranking-result-display');

            // ローディング表示
            resultDisplayArea.innerHTML = `<p class="text-center">レベル ${level} のランキングを読み込み中...</p>`;
            
            // 画面切り替え（レベル選択を隠し、結果表示を見せる）
            levelSelectArea.classList.add('hidden');
            resultDisplayArea.classList.remove('hidden');

            // ★fetch API (GETリクエスト) に ?level= パラメータを追加
            fetch(GAS_WEB_APP_URL + "?level=" + level) 
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        throw new Error(data.message);
                    }
                    
                    let html = `<h3 class="text-xl font-bold text-yellow-400 text-center mb-3">🏆 レベル ${level} TOP 10 🏆</h3>`;
                    
                    if (data.length === 0) {
                        html += '<p class="text-center">まだランキングデータがありません。</p>';
                    } else {
                        html += '<ol class="list-decimal list-inside space-y-2">';
                        
                        data.forEach((item, index) => {
                            let medal = '';
                            if(index === 0) medal = '🥇';
                            if(index === 1) medal = '🥈';
                            if(index === 2) medal = '🥉';
                            
                            // ★スコアとタイム(item.time)を表示するように修正
                            const formattedTime = formatTime(item.time);
                            html += `<li>${medal} <strong>${item.name}</strong>: ${item.score}点 (${formattedTime})</li>`;
                        });
                        
                        html += '</ol>';
                    }
                    
                    // 「レベル選択に戻る」ボタンを追加
                    // displayRanking()を呼ぶと、レベル選択画面に戻る
                    html += '<button onclick="displayRanking()" class="mt-4 w-full p-2 bg-gray-600 hover:bg-gray-700 rounded">レベル選択に戻る</button>';
                    
                    resultDisplayArea.innerHTML = html;
                })
                .catch(error => {
                    console.error('ランキング取得エラー:', error);
                    resultDisplayArea.innerHTML = `<p class="text-center text-red-500">ランキングの取得に失敗しました。</p><button onclick="displayRanking()" class="mt-4 w-full p-2 bg-gray-600 hover:bg-gray-700 rounded">レベル選択に戻る</button>`;
                });
        }
		function closeRankingDisplay() {
            // (処理内容は変更なし)
            rankingDisplayArea.classList.add('hidden');
            document.getElementById('ranking-result-display').classList.add('hidden');
            document.getElementById('ranking-level-select').classList.remove('hidden');
            showRankingButton.innerHTML = '🏆 ランキングを見る';
        }
		function showLevelSelect() {
            // (処理内容は変更なし)
            document.getElementById('ranking-result-display').classList.add('hidden');
            document.getElementById('ranking-level-select').classList.remove('hidden');
        }
        // --- 5. イベントリスナーの登録 ---
        // addEventListener: HTML要素が「～された時」に「～する」という処理を予約します。
        
        // 'home-button' が 'click' された時、'handleHomeClick' 関数を実行する
        homeButton.addEventListener('click', handleHomeClick); 
        // 'start-button' が 'click' された時、'startGame' 関数を実行する
        startButton.addEventListener('click', startGame);
        // 'next-button' が 'click' された時、'nextQuestion' 関数を実行する
        nextButton.addEventListener('click', nextQuestion); 
        showRankingButton.addEventListener('click', displayRanking);
        // ▲▲▲ JavaScriptの処理終了 ▲▲▲
    </script>
</body>
</html>